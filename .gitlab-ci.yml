# Fallout 1 Reverse Engineering - GitLab CI/CD Pipeline
# Builds Win32 multiplayer client and server components

stages:
  - build
  - package
  - deploy

variables:
  GIT_DEPTH: 10
  GIT_SUBMODULE_STRATEGY: recursive

# ============================================================================
# Win32 Game Client Build
# ============================================================================

# Common Windows build template
.windows-build:
  tags:
    - windows
    - shell
  before_script:
    # Add CMake to PATH - try common installation paths
    - |
      $cmakePaths = @(
        "C:\Program Files\CMake\bin",
        "C:\Program Files (x86)\CMake\bin",
        "C:\ProgramData\chocolatey\bin"
      )
      foreach ($path in $cmakePaths) {
        if (Test-Path "$path\cmake.exe") {
          $env:Path = "$path;$env:Path"
          Write-Host "Found CMake at $path"
          break
        }
      }
    # If CMake still not found, install via Chocolatey
    - |
      if (-not (Get-Command cmake -ErrorAction SilentlyContinue)) {
        Write-Host "CMake not found, installing via Chocolatey..."
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y --no-progress
        $env:Path = "C:\Program Files\CMake\bin;$env:Path"
      }
    - cmake --version

build-win32:
  extends: .windows-build
  stage: build
  variables:
    CMAKE_BUILD_TYPE: Release
  script:
    - Write-Host "Configuring CMake for Win32..."
    - cmake -B build-win32 -G "Visual Studio 17 2022" -A Win32
    - Write-Host "Building Win32 Release..."
    - cmake --build build-win32 --config Release --parallel
  artifacts:
    name: "fallout1-re-win32-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build-win32/Release/fallout-re.exe
    expire_in: 30 days
  cache:
    key: win32-cmake-${CI_COMMIT_REF_SLUG}
    paths:
      - build-win32/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

build-win32-debug:
  extends: .windows-build
  stage: build
  script:
    - cmake -B build-win32-debug -G "Visual Studio 17 2022" -A Win32
    - cmake --build build-win32-debug --config RelWithDebInfo --parallel
  artifacts:
    name: "fallout1-re-win32-debug-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build-win32-debug/RelWithDebInfo/fallout-re.exe
      - build-win32-debug/RelWithDebInfo/fallout-re.pdb
    expire_in: 7 days
  cache:
    key: win32-debug-cmake-${CI_COMMIT_REF_SLUG}
    paths:
      - build-win32-debug/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ============================================================================
# Debian Runner Template
# ============================================================================
.debian-build:
  tags:
    - debian
  before_script:
    # Ensure Node.js is available
    - |
      if ! command -v node &> /dev/null; then
        echo "Installing Node.js..."
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        sudo apt-get install -y nodejs
      fi
    - node --version
    - npm --version

# ============================================================================
# Multiplayer Server Build (Node.js)
# ============================================================================
build-server:
  extends: .debian-build
  stage: build
  script:
    - cd fallout1-server
    - npm ci
    - npx prisma generate
    - npm run build
  artifacts:
    name: "fallout1-server-${CI_COMMIT_SHORT_SHA}"
    paths:
      - fallout1-server/dist/
    expire_in: 30 days
  cache:
    key: server-npm-${CI_COMMIT_REF_SLUG}
    paths:
      - fallout1-server/node_modules/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - changes:
        - fallout1-server/**/*

# ============================================================================
# Web Frontend Build
# ============================================================================
build-web:
  extends: .debian-build
  stage: build
  script:
    - cd fallout1-web
    - npm ci
    - npm run build
  artifacts:
    name: "fallout1-web-${CI_COMMIT_SHORT_SHA}"
    paths:
      - fallout1-web/dist/
    expire_in: 30 days
  cache:
    key: web-npm-${CI_COMMIT_REF_SLUG}
    paths:
      - fallout1-web/node_modules/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - changes:
        - fallout1-web/**/*

# ============================================================================
# Package Stage - Create Release Archive
# ============================================================================
package-release:
  stage: package
  tags:
    - debian
  needs:
    - job: build-win32
      artifacts: true
    - job: build-server
      artifacts: true
      optional: true
    - job: build-web
      artifacts: true
      optional: true
  script:
    - sudo apt-get update && sudo apt-get install -y zip || true
    - mkdir -p release
    - cp build-win32/Release/fallout-re.exe release/
    - |
      if [ -d "fallout1-server/dist" ]; then
        mkdir -p release/server
        cp -r fallout1-server/dist/* release/server/
      fi
    - |
      if [ -d "fallout1-web/dist" ]; then
        mkdir -p release/web
        cp -r fallout1-web/dist/* release/web/
      fi
    - cd release && zip -r ../fallout1-re-${CI_COMMIT_SHORT_SHA}.zip .
  artifacts:
    name: "fallout1-re-release-${CI_COMMIT_SHORT_SHA}"
    paths:
      - fallout1-re-*.zip
    expire_in: 90 days
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# ============================================================================
# Deploy Stage (Manual)
# ============================================================================
deploy-staging:
  stage: deploy
  tags:
    - debian
  needs:
    - job: package-release
      artifacts: true
  script:
    - echo "Deploying to staging environment..."
    - echo "Release artifact ready at fallout1-re-${CI_COMMIT_SHORT_SHA}.zip"
    - ls -la fallout1-re-*.zip
  environment:
    name: staging
    url: https://staging.fallout1-mp.example.com
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual

deploy-production:
  stage: deploy
  tags:
    - debian
  needs:
    - job: package-release
      artifacts: true
  script:
    - echo "Deploying to production environment..."
    - ls -la fallout1-re-*.zip
  environment:
    name: production
    url: https://fallout1-mp.example.com
  rules:
    - if: $CI_COMMIT_TAG
      when: manual
