# Fallout 1 Reverse Engineering - GitLab CI/CD Pipeline
# Builds Win32 multiplayer client and server components

stages:
  - build
  - package
  - deploy

variables:
  GIT_DEPTH: 10
  GIT_SUBMODULE_STRATEGY: recursive

# ============================================================================
# Win32 Game Client Build
# ============================================================================

# Common Windows build template
.windows-build:
  tags:
    - windows
    - shell
  before_script:
    # Add CMake to PATH - try common installation paths
    - |
      $cmakePaths = @(
        "C:\Program Files\CMake\bin",
        "C:\Program Files (x86)\CMake\bin",
        "C:\ProgramData\chocolatey\bin"
      )
      foreach ($path in $cmakePaths) {
        if (Test-Path "$path\cmake.exe") {
          $env:Path = "$path;$env:Path"
          Write-Host "Found CMake at $path"
          break
        }
      }
    # If CMake still not found, install via Chocolatey
    - |
      if (-not (Get-Command cmake -ErrorAction SilentlyContinue)) {
        Write-Host "CMake not found, installing via Chocolatey..."
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y --no-progress
        $env:Path = "C:\Program Files\CMake\bin;$env:Path"
      }
    - cmake --version

build-win32:
  extends: .windows-build
  stage: build
  variables:
    CMAKE_BUILD_TYPE: Release
  script:
    - Write-Host "Configuring CMake for Win32..."
    - cmake -B build-win32 -G "Visual Studio 17 2022" -A Win32
    - Write-Host "Building Win32 Release..."
    - cmake --build build-win32 --config Release --parallel
  artifacts:
    name: "fallout1-re-win32-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build-win32/Release/fallout-re.exe
    expire_in: 30 days
  cache:
    key: win32-cmake-${CI_COMMIT_REF_SLUG}
    paths:
      - build-win32/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

build-win32-debug:
  extends: .windows-build
  stage: build
  script:
    - cmake -B build-win32-debug -G "Visual Studio 17 2022" -A Win32
    - cmake --build build-win32-debug --config RelWithDebInfo --parallel
  artifacts:
    name: "fallout1-re-win32-debug-${CI_COMMIT_SHORT_SHA}"
    paths:
      - build-win32-debug/RelWithDebInfo/fallout-re.exe
      - build-win32-debug/RelWithDebInfo/fallout-re.pdb
    expire_in: 7 days
  cache:
    key: win32-debug-cmake-${CI_COMMIT_REF_SLUG}
    paths:
      - build-win32-debug/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ============================================================================
# Debian Runner Template
# ============================================================================
.debian-build:
  tags:
    - debian
  before_script:
    # Ensure Node.js is available
    - |
      if ! command -v node &> /dev/null; then
        echo "Installing Node.js..."
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        sudo apt-get install -y nodejs
      fi
    - node --version
    - npm --version

# ============================================================================
# Multiplayer Server Build (Node.js)
# ============================================================================
build-server:
  extends: .debian-build
  stage: build
  script:
    - cd fallout1-server
    - npm ci
    - npx prisma generate
    - npm run build
  artifacts:
    name: "fallout1-server-${CI_COMMIT_SHORT_SHA}"
    paths:
      - fallout1-server/dist/
    expire_in: 30 days
  cache:
    key: server-npm-${CI_COMMIT_REF_SLUG}
    paths:
      - fallout1-server/node_modules/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - changes:
        - fallout1-server/**/*

# ============================================================================
# Web Frontend Build
# ============================================================================
build-web:
  extends: .debian-build
  stage: build
  script:
    - cd fallout1-web
    - npm ci
    - npm run build
  artifacts:
    name: "fallout1-web-${CI_COMMIT_SHORT_SHA}"
    paths:
      - fallout1-web/dist/
    expire_in: 30 days
  cache:
    key: web-npm-${CI_COMMIT_REF_SLUG}
    paths:
      - fallout1-web/node_modules/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - changes:
        - fallout1-web/**/*

# ============================================================================
# Multiplayer Launcher Build (Electron)
# ============================================================================
build-launcher:
  stage: build
  tags:
    - windows
    - shell
  script:
    - cd fallout1-launcher
    - npm ci
    - npm run build
  artifacts:
    name: "fallout1-launcher-${CI_COMMIT_SHORT_SHA}"
    paths:
      - fallout1-launcher/dist/*.exe
    expire_in: 30 days
  cache:
    key: launcher-npm-${CI_COMMIT_REF_SLUG}
    paths:
      - fallout1-launcher/node_modules/
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - changes:
        - fallout1-launcher/**/*

# ============================================================================
# Package Stage - Create Release Archive
# ============================================================================
package-release:
  stage: package
  tags:
    - windows
  needs:
    - job: build-win32
      artifacts: true
    - job: build-launcher
      artifacts: true
      optional: true
  script:
    - New-Item -ItemType Directory -Path release -Force
    - Copy-Item -Path "build-win32\Release\fallout-re.exe" -Destination release\ -Force
    - |
      if (Test-Path "fallout1-launcher\dist\*.exe") {
        Copy-Item -Path "fallout1-launcher\dist\*.exe" -Destination release\ -Force
      }
    - Compress-Archive -Path release\* -DestinationPath "fallout1-re-$env:CI_COMMIT_SHORT_SHA.zip" -Force
  artifacts:
    name: "fallout1-re-release-${CI_COMMIT_SHORT_SHA}"
    paths:
      - fallout1-re-*.zip
    expire_in: 90 days
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# ============================================================================
# Deploy Stage
# ============================================================================
deploy-win32:
  stage: deploy
  tags:
    - windows
  needs:
    - job: build-win32
      artifacts: true
    - job: build-win32-debug
      artifacts: true
    - job: build-launcher
      artifacts: true
      optional: true
  script:
    - 'net use R: \\192.168.100.22\releases gitlab /user:root'
    - '$destPath = "R:\$env:CI_PROJECT_NAME\$env:CI_COMMIT_REF_NAME"'
    - 'if (-not (Test-Path $destPath)) { New-Item -ItemType Directory -Path $destPath -Force }'
    - 'Copy-Item -Path "build-win32\Release\fallout-re.exe" -Destination $destPath -Force'
    - 'Copy-Item -Path "build-win32-debug\RelWithDebInfo\fallout-re.exe" -Destination "$destPath\fallout-re-debug.exe" -Force -ErrorAction SilentlyContinue'
    - 'Copy-Item -Path "build-win32-debug\RelWithDebInfo\fallout-re.pdb" -Destination $destPath -Force -ErrorAction SilentlyContinue'
    - 'Copy-Item -Path "fallout1-launcher\dist\*.exe" -Destination $destPath -Force -ErrorAction SilentlyContinue'
    - 'net use R: /delete'
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
